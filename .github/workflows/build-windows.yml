name: Build Windows
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'

      - name: Enable Windows desktop
        run: flutter config --enable-windows-desktop

      - name: Get dependencies
        run: flutter pub get

      - name: Build Windows app
        run: flutter build windows --release

      - name: List build output (for debugging)
        run: |
          echo "Listing Release folder contents:"
          dir build\windows\x64\runner\Release
          echo "Looking for .exe files:"
          dir build\windows\x64\runner\Release\*.exe

      - name: Create NSIS installer script
        run: |
          $nsisScript = @'
          ; Set compression
          SetCompressor /SOLID lzma
          
          ; Include Modern UI
          !include "MUI2.nsh"
          
          ; Name and file
          Name "Chizimba Data Management System"
          OutFile "ChizimbaDataManagementSystem-Installer.exe"
          
          ; Default installation folder
          InstallDir "$PROGRAMFILES64\ChizimbaDataManagementSystem"
          
          ; Get installation folder from registry if available
          InstallDirRegKey HKCU "Software\ChizimbaDataManagementSystem" ""
          
          ; Request application privileges for Windows Vista and higher
          RequestExecutionLevel admin
          
          ; Interface Settings
          !define MUI_ABORTWARNING
          
          ; Pages
          !insertmacro MUI_PAGE_DIRECTORY
          !insertmacro MUI_PAGE_INSTFILES
          
          !insertmacro MUI_UNPAGE_CONFIRM
          !insertmacro MUI_UNPAGE_INSTFILES
          
          ; Languages
          !insertmacro MUI_LANGUAGE "English"
          
          ; Installer sections
          Section "Main Application" SecMain
            SectionIn RO
          
            SetOutPath "$INSTDIR"
          
            ; Add files
            File /r "build\windows\x64\runner\Release\*"
          
            ; Store installation folder
            WriteRegStr HKCU "Software\ChizimbaDataManagementSystem" "" $INSTDIR
          
            ; Create uninstaller
            WriteUninstaller "$INSTDIR\Uninstall.exe"
          
            ; Create shortcuts
            CreateDirectory "$SMPROGRAMS\ChizimbaDataManagementSystem"
            CreateShortcut "$SMPROGRAMS\ChizimbaDataManagementSystem\Chizimba.lnk" "$INSTDIR\chizimba_data_management_system.exe"
            CreateShortcut "$SMPROGRAMS\ChizimbaDataManagementSystem\Uninstall.lnk" "$INSTDIR\Uninstall.exe"
            CreateShortcut "$DESKTOP\Chizimba Data Management System.lnk" "$INSTDIR\chizimba_data_management_system.exe"
          
            ; Add registry entries for uninstaller
            WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\ChizimbaDataManagementSystem" "DisplayName" "Chizimba Data Management System"
            WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\ChizimbaDataManagementSystem" "UninstallString" "$\"$INSTDIR\Uninstall.exe$\""
            WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\ChizimbaDataManagementSystem" "DisplayIcon" "$\"$INSTDIR\chizimba_data_management_system.exe$\""
            WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\ChizimbaDataManagementSystem" "Publisher" "Jaytechsolutions"
            WriteRegDWORD HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\ChizimbaDataManagementSystem" "NoModify" 1
            WriteRegDWORD HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\ChizimbaDataManagementSystem" "NoRepair" 1
          SectionEnd
          
          ; Uninstaller section
          Section "Uninstall"
            ; Remove application files
            RMDir /r "$INSTDIR"
          
            ; Remove shortcuts
            Delete "$SMPROGRAMS\ChizimbaDataManagementSystem\Chizimba.lnk"
            Delete "$SMPROGRAMS\ChizimbaDataManagementSystem\Uninstall.lnk"
            Delete "$DESKTOP\Chizimba Data Management System.lnk"
            RMDir "$SMPROGRAMS\ChizimbaDataManagementSystem"
          
            ; Remove registry entries
            DeleteRegKey HKCU "Software\ChizimbaDataManagementSystem"
            DeleteRegKey HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\ChizimbaDataManagementSystem"
          SectionEnd
          '@
          
          $nsisScript | Out-File -Encoding UTF8 -FilePath "installer.nsi"

      - name: Install NSIS and create installer
        run: |
          choco install nsis -y
          makensis installer.nsi

      - name: Upload installer
        uses: actions/upload-artifact@v4
        with:
          name: chizimba-installer
          path: ChizimbaDataManagementSystem-Installer.exe